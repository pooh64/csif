apiVersion: v1
kind: Service
metadata:
  name: csi-csif-fs
spec:
  selector:
    app: csi-csif-fs
  clusterIP: None
  ports:
  - port: 9820
    name: server-port
  - port: 9821
    name: tgtport
---
kind: StatefulSet
apiVersion: apps/v1
metadata:
  name: csi-csif-fs
#  namespace: kube-system
spec:
  serviceName: csi-csif-fs
  replicas: 1
  selector:
    matchLabels:
      app: csi-csif-fs
  template:
    metadata:
      labels:
        app: csi-csif-fs
    spec:
      #serviceAccountName: csi-csif-fs-sa 
      dnsPolicy: ClusterFirstWithHostNet
      hostNetwork: true
      # priorityClassName: system-cluster-critical # requires kube-system
      #tolerations:
      #  - key: "node-role.kubernetes.io/master"
      #    operator: "Equal"
      #    value: "true"
      #    effect: "NoSchedule"
      containers:
        - name: filter
          image: pooh64/csif-filter:latest
          imagePullPolicy: Always
          args:
            - "--endpoint=tcp://:9820"
            - "--tgtport=9821"
            - "--tgtcontrol=9721"
            - "--v=5"
          ports:
            - containerPort: 9820
              name: server-port
            - containerPort: 9821
              name: tgtport
          volumeMounts:
            - name: dev-dir
              mountPath: /dev
          securityContext:
            privileged: true
            capabilities:
              add: ["SYS_ADMIN"]
          resources:
            limits:
              cpu: 500m
              memory: 500Mi
            requests:
              cpu: 50m
              memory: 20Mi
#################################################
      volumes:
        - name: dev-dir
          hostPath:
            path: /dev
            type: Directory